# Authentication API

REST API –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–µ–π (RBAC).

## üìã –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ª–æ–≥–∏–Ω, refresh —Ç–æ–∫–µ–Ω–æ–≤, logout
- **JWT —Ç–æ–∫–µ–Ω—ã**: access + refresh —Å —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î
- **RBAC**: –≥–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (CRUD –¥–ª—è 3 —Ä–µ—Å—É—Ä—Å–æ–≤)
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: email —á–µ—Ä–µ–∑ Pydantic `EmailStr`
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π bcrypt, –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**: –ø–æ–ª–Ω—ã–π —Å—Ç–µ–∫ async (FastAPI + asyncpg + SQLAlchemy)

## üõ† –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è |
|-----------|------------|
| Framework | FastAPI 0.109 |
| –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | PostgreSQL 13.3 |
| ORM | SQLAlchemy 2.0 (async) |
| –î—Ä–∞–π–≤–µ—Ä –ë–î | asyncpg |
| –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è | PyJWT |
| –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ | bcrypt |
| –í–∞–ª–∏–¥–∞—Ü–∏—è | Pydantic 2 |
| –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã | Docker, docker-compose |

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd app
pip install -r requirements.txt
```

### 2. –ó–∞–ø—É—Å–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
docker-compose up -d
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–§–∞–π–ª `.env` —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:

```env
SECRET_KEY=your_secret_key
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=15
REFRESH_TOKEN_EXPIRE_DAYS=7

DB_USER=postgres
DB_PASSWORD=postgres
DB_HOST=localhost
DB_PORT=5432
DB_NAME=auth_db
```

> ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –∑–∞–º–µ–Ω–∏—Ç–µ `SECRET_KEY` –Ω–∞ —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º!

### 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
python reset_and_populate_test_data.py
```

–°–æ–∑–¥–∞—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–ø–∞—Ä–æ–ª—å: `password123`):

| Email | –†–æ–ª—å |
|-------|------|
| `admin@example.com` | admin |
| `ivan@example.com` | user |
| `maria@example.com` | moderator |
| `alexey@example.com` | user |
| `elena@example.com` | manager |

### 5. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### 6. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
- **Swagger UI:** http://localhost:8000/docs
- **ReDoc:** http://localhost:8000/redoc

---

## üì° API Endpoints

### Authentication (`/authentication`)

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| POST | `/register` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| POST | `/login` | –õ–æ–≥–∏–Ω (–ø–æ–ª—É—á–µ–Ω–∏–µ access + refresh —Ç–æ–∫–µ–Ω–æ–≤) |
| POST | `/refresh` | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ refresh-—Ç–æ–∫–µ–Ω—É |
| POST | `/logout` | –í—ã—Ö–æ–¥ (–æ—Ç–∑—ã–≤ refresh-—Ç–æ–∫–µ–Ω–∞) |
| POST | `/cleanup-tokens` | –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö refresh-—Ç–æ–∫–µ–Ω–æ–≤ |

### Admin Panel (`/admin`)

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/users` | –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç—Ä–µ–±—É–µ—Ç—Å—è `read_all`) |
| GET | `/users/{id}` | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (—Ç—Ä–µ–±—É–µ—Ç—Å—è `read`) |
| PUT | `/users/{id}/role` | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è `update`) |
| PUT | `/users/{id}/activate` | –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å (—Ç—Ä–µ–±—É–µ—Ç—Å—è `update`) |
| PUT | `/users/{id}/deactivate` | –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å (—Ç—Ä–µ–±—É–µ—Ç—Å—è `update`) |
| DELETE | `/users/{id}` | –£–¥–∞–ª–∏—Ç—å (—Ç—Ä–µ–±—É–µ—Ç—Å—è `delete`) |

### User Profile (`/profile`)

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/` | –ü—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| PUT | `/delete` | –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ (soft delete) |
| PUT | `/update/{parameter}` | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è |

### Permissions (`/permissions`)

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/` | –í—Å–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è `read_all`) |
| POST | `/{role_name}` | –°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∞ –¥–ª—è —Ä–æ–ª–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è `create`) |
| GET | `/{role_name}` | –ü—Ä–∞–≤–∞ –¥–ª—è —Ä–æ–ª–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è `read`) |
| PUT | `/{role_name}` | –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è `update`) |
| DELETE | `/{role_name}` | –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è `delete`) |

### Business Elements (`/business-elements`)

| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/` | –í—Å–µ –±–∏–∑–Ω–µ—Å-—ç–ª–µ–º–µ–Ω—Ç—ã (—Ç—Ä–µ–±—É–µ—Ç—Å—è `read_all`) |
| GET | `/{name}` | –≠–ª–µ–º–µ–Ω—Ç –ø–æ –∏–º–µ–Ω–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è `read`) |
| POST | `/` | –°–æ–∑–¥–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç (—Ç—Ä–µ–±—É–µ—Ç—Å—è `create`) |
| PUT | `/{name}` | –û–±–Ω–æ–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç (—Ç—Ä–µ–±—É–µ—Ç—Å—è `update`) |
| DELETE | `/{name}` | –£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç (—Ç—Ä–µ–±—É–µ—Ç—Å—è `delete`) |
| GET | `/{name}/` | Mock-view —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–æ–ª–∏ |

---

## üîê –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

### –†–µ—Å—É—Ä—Å—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è

| –†–µ—Å—É—Ä—Å | create | read | read_all | update | delete |
|--------|--------|------|----------|--------|--------|
| `users` | ‚úì | ‚úì | ‚úì | ‚úì | ‚úì |
| `permissions` | ‚úì | ‚úì | ‚úì | ‚úì | ‚úì |
| `business_elements` | ‚úì | ‚úì | ‚úì | ‚úì | ‚úì |

### –†–æ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

| –†–æ–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `admin` | –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ä–µ—Å—É—Ä—Å–∞–º |
| `moderator` | –ß—Ç–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ |
| `manager` | –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ |
| `user` | –ë–∞–∑–æ–≤—ã–π –¥–æ—Å—Ç—É–ø (—á—Ç–µ–Ω–∏–µ —Å–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö) |

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
auth_api/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                     # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ config.py                   # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (pydantic-settings)
‚îÇ   ‚îú‚îÄ‚îÄ .env                        # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml          # Docker-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt            # Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ reset_and_populate_test_data.py
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py             # DB engine, —Å–µ—Å—Å–∏–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ models_db.py            # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py                 # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.py                # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py                 # –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ permission.py           # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ business_elements.py    # –ë–∏–∑–Ω–µ—Å-—ç–ª–µ–º–µ–Ω—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ tools/
‚îÇ       ‚îú‚îÄ‚îÄ auth_func.py            # JWT, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
‚îÇ       ‚îú‚îÄ‚îÄ hash.py                 # –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ bcrypt
‚îÇ       ‚îî‚îÄ‚îÄ schemas.py              # Pydantic —Å—Ö–µ–º—ã
‚îî‚îÄ‚îÄ README.md
```

---

## üîß –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

```bash
curl -X POST http://localhost:8000/authentication/register \
  -H "Content-Type: application/json" \
  -d '{
    "first_name": "John",
    "last_name": "Doe",
    "patronymic": "Ivanovich",
    "email": "john@example.com",
    "password": "password123",
    "password_confirm": "password123"
  }'
```

### –õ–æ–≥–∏–Ω

```bash
curl -X POST http://localhost:8000/authentication/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "password123"
  }'
```

### –ó–∞–ø—Ä–æ—Å —Å —Ç–æ–∫–µ–Ω–æ–º

```bash
curl -X GET http://localhost:8000/profile/ \
  -H "Authorization: Bearer <access_token>"
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|--------------|----------|
| `SECRET_KEY` | `your_secret_key` | –ö–ª—é—á –¥–ª—è JWT |
| `ALGORITHM` | `HS256` | –ê–ª–≥–æ—Ä–∏—Ç–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è JWT |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | `15` | –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ access-—Ç–æ–∫–µ–Ω–∞ |
| `REFRESH_TOKEN_EXPIRE_DAYS` | `7` | –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ refresh-—Ç–æ–∫–µ–Ω–∞ |
| `DB_USER` | `postgres` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î |
| `DB_PASSWORD` | `postgres` | –ü–∞—Ä–æ–ª—å –ë–î |
| `DB_HOST` | `localhost` | –•–æ—Å—Ç –ë–î |
| `DB_PORT` | `5432` | –ü–æ—Ä—Ç –ë–î |
| `DB_NAME` | `auth_db` | –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö |

---

## üõ° –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

1. **SECRET_KEY**: —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–æ–∫—É (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)
   ```python
   import secrets
   print(secrets.token_urlsafe(32))
   ```

2. **CORS**: —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã –≤ `main.py`:
   ```python
   allow_origins=["https://yourdomain.com"]
   ```

3. **HTTPS**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –æ–±—Ä–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Å–∏ (nginx, traefik)

4. **Rate Limiting**: –¥–æ–±–∞–≤—å—Ç–µ `slowapi` –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç brute-force

5. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Alembic –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ö–µ–º

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ (–µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã)
pytest

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ (–µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω mypy)
mypy .
```

---

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
